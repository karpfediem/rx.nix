# Build the mgmt deploy directory from IR
{ lib }:
{ pkgs, name, filesIR, mclText }:

pkgs.stdenvNoCC.mkDerivation {
  pname = "rxnix-deploy-${name}";
  version = "0.0.1";
  nativeBuildInputs = [ pkgs.jq ];
  preferLocalBuild = true;
  allowSubstitutes = false;
  # TODO replace with builder outside nix that consumes IR to build the MCL deploy
  buildCommand = ''
    set -euo pipefail
    mkdir -p "$out/deploy/files"

    # 1) metadata.yaml — default entry point (main.mcl) and default files dir
    cat > "$out/deploy/metadata.yaml" <<'YAML'
# empty metadata is fine; main.mcl + files/ are the defaults
YAML

    # 2) main.mcl — the generated MCL program
    cat > "$out/deploy/main.mcl" <<'MCL'
# AUTOGENERATED by rx.nix
${mclText}
MCL

    # 3) manifest.json (optional debug artifact)
    cat > "$out/manifest.json" <<'JSON'
${builtins.toJSON filesIR}
JSON

    # 4) Materialize payload under deploy/files/...
    jq -r '.files[] | @base64' "$out/manifest.json" | while read -r line; do
      obj=$(echo "$line" | base64 -d)
      absPath=$(echo "$obj" | jq -r '.path')
      content=$(echo "$obj" | jq -r '."__content" // empty')
      source=$(echo "$obj" | jq -r '."__source"  // empty')

      if [ -n "$content" ]; then
        dest="$out/deploy/files$absPath"
        mkdir -p "$(dirname "$dest")"
        printf "%s" "$content" > "$dest"
      elif [ -n "$source" ]; then
        echo "source reference given, no need to copy" # We do not need to store source as it would just copy a file we aren't even looking at.
      else
        echo "missing content/source for $absPath" >&2
        exit 1
      fi
    done
  '';
}
